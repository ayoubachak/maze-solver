<div class="ai-trainer-container">
  <!-- Header -->
  <div class="header fade-in">
    <h1 class="section-title">
      <mat-icon>school</mat-icon>
      AI Trainer
    </h1>
    <p class="subtitle">
      Train reinforcement learning agents to solve mazes using Q-Learning or Deep Q-Networks (DQN).
    </p>
  </div>

  <!-- Main Layout: Controls | Maze | Stats/Visualization -->
  <div class="trainer-layout">
    <!-- Left Panel: Controls & Config -->
    <div class="controls-panel">
      <mat-card class="control-card">
        <mat-card-header>
          <mat-card-title>Training Setup</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Choose AI Algorithm</mat-label>
            <mat-select [(value)]="selectedAlgorithm" [disabled]="isRunning">
              <mat-option *ngFor="let alg of algorithms" [value]="alg.value">
                {{ alg.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="algorithm-description" *ngIf="getAlgorithmDescription()">
            <mat-icon color="accent">info</mat-icon>
            <span>{{ getAlgorithmDescription() }}</span>
          </div>

          <div class="btn-group top-margin">
            <button mat-raised-button color="primary" (click)="generateMaze()" [disabled]="isRunning">
              <mat-icon>shuffle</mat-icon>
              New Maze ({{mazeSize.width}}x{{mazeSize.height}})
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Algorithm Configuration -->
      <mat-card class="config-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>tune</mat-icon>
            {{ selectedAlgorithm === AlgorithmType.DQN ? 'DQN' : 'Q-Learning' }} Settings
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Q-Learning Config -->
          <div *ngIf="selectedAlgorithm === AlgorithmType.QLEARNING" class="config-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Learning Rate (α)</mat-label>
              <input matInput type="number" [(ngModel)]="qLearningConfig.learningRate" [disabled]="isRunning" step="0.01" min="0" max="1">
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Discount Factor (γ)</mat-label>
              <input matInput type="number" [(ngModel)]="qLearningConfig.discountFactor" [disabled]="isRunning" step="0.01" min="0" max="1">
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Exploration Rate (ε)</mat-label>
              <input matInput type="number" [(ngModel)]="qLearningConfig.explorationRate" [disabled]="isRunning" step="0.01" min="0" max="1">
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Episodes</mat-label>
              <input matInput type="number" [(ngModel)]="qLearningConfig.episodes" [disabled]="isRunning" step="100" min="1">
            </mat-form-field>
          </div>

          <!-- DQN Config -->
          <div *ngIf="selectedAlgorithm === AlgorithmType.DQN" class="config-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Hidden Layers (comma-sep)</mat-label>
              <input matInput type="text" [(ngModel)]="dqnConfig.hiddenLayers" [disabled]="isRunning" placeholder="e.g., 128,64">
            </mat-form-field>
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Learning Rate</mat-label>
                <input matInput type="number" [(ngModel)]="dqnConfig.learningRate" [disabled]="isRunning" step="0.0001" min="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Batch Size</mat-label>
                <input matInput type="number" [(ngModel)]="dqnConfig.batchSize" [disabled]="isRunning" step="1" min="1">
              </mat-form-field>
            </div>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Activation Function</mat-label>
              <mat-select [(ngModel)]="dqnConfig.activation" [disabled]="isRunning">
                <mat-option value="relu">ReLU</mat-option>
                <mat-option value="sigmoid">Sigmoid</mat-option>
                <mat-option value="tanh">Tanh</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Action Buttons -->
      <mat-card class="control-card action-buttons">
        <mat-card-content>
          <div class="btn-group">
            <button mat-flat-button color="primary" (click)="startTraining()" [disabled]="isRunning || !maze">
              <mat-icon>play_arrow</mat-icon>
              Start Training
            </button>
            <button mat-flat-button color="warn" (click)="stopTraining()" [disabled]="!isRunning">
              <mat-icon>stop</mat-icon>
              Stop Training
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Center Panel: Maze Visualization -->
    <div class="maze-panel">
      <mat-card class="maze-display-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>grid_on</mat-icon>
            Agent Environment
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="maze-container" *ngIf="maze">
            <div class="maze-grid">
              <div *ngFor="let row of maze.grid; let y = index" class="maze-row">
                <div *ngFor="let cell of row; let x = index" 
                     [class]="getCellClass(cell.type, x, y)"
                     [matTooltip]="getCellTooltip(cell.type, x, y)"
                     >
                </div>
              </div>
            </div>
            <!-- Q-Values Visualization for Q-Learning -->
            <div *ngIf="selectedAlgorithm === AlgorithmType.QLEARNING && showQValues" class="q-values-overlay">
              <div class="q-value-legend">
                <span class="legend-item">
                  <span class="color-indicator high-q"></span>
                  High Q-Value
                </span>
                <span class="legend-item">
                  <span class="color-indicator low-q"></span>
                  Low Q-Value
                </span>
              </div>
            </div>
          </div>
          <div *ngIf="!maze" class="maze-placeholder">
            <mat-icon>info_outline</mat-icon>
            <p>Generate a maze to begin training.</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Right Panel: Stats & Neural Network Visualization -->
    <div class="visualization-panel">
      <!-- Training Stats -->
      <mat-card class="stats-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>trending_up</mat-icon>
            Training Progress
          </mat-card-title>
        </mat-card-header>
        <mat-card-content *ngIf="trainingStats">
          <mat-progress-bar 
            mode="determinate" 
            [value]="(trainingStats.episode / qLearningConfig.episodes) * 100"
            *ngIf="isRunning || trainingStats.episode > 0">
          </mat-progress-bar>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">Episode:</span>
              <span class="stat-value">{{ trainingStats.episode }} / {{ qLearningConfig.episodes }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Steps:</span>
              <span class="stat-value">{{ trainingStats.steps }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Reward:</span>
              <span class="stat-value">{{ trainingStats.totalReward.toFixed(2) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Success Rate:</span>
              <span class="stat-value">{{ trainingStats.successRate.toFixed(2) }}%</span>
            </div>
            <div class="stat-item status-message" *ngIf="!isRunning && trainingStats.episode === qLearningConfig.episodes">
              <mat-icon color="primary">check_circle</mat-icon> Training Complete!
            </div>
          </div>
        </mat-card-content>
        <mat-card-content *ngIf="!trainingStats && !isRunning">
          <p class="no-stats">Start training to see progress.</p>
        </mat-card-content>
        <mat-card-content *ngIf="isRunning && !trainingStats">
          <p class="no-stats">Initializing training...</p>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </mat-card-content>
      </mat-card>

      <!-- Neural Network Visualization (DQN only) -->
      <mat-card *ngIf="selectedAlgorithm === AlgorithmType.DQN" class="neural-network-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>device_hub</mat-icon>
            Neural Network
          </mat-card-title>
          <div class="header-actions">
            <button mat-icon-button (click)="toggleNetworkVisualization()" 
                    [matTooltip]="showNetworkViz ? 'Hide Network' : 'Show Network'">
              <mat-icon>{{ showNetworkViz ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="showNetworkViz" class="network-visualization">
            <div class="network-container">
              <svg #networkSvg class="network-svg"></svg>
              <div *ngIf="!isDqnActive || !networkData" class="network-status">
                <mat-icon>info_outline</mat-icon>
                <p>{{ networkStatusMessage }}</p>
              </div>
            </div>
            <div class="network-legend">
              <span class="legend-item"><span class="neuron-indicator input"></span> Input</span>
              <span class="legend-item"><span class="neuron-indicator hidden"></span> Hidden</span>
              <span class="legend-item"><span class="neuron-indicator output"></span> Output</span>
            </div>
          </div>
          <div *ngIf="!showNetworkViz" class="network-collapsed">
            <p>Click the eye icon to visualize the neural network structure.</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Q-Learning Visualization -->
      <mat-card *ngIf="selectedAlgorithm === AlgorithmType.QLEARNING" class="q-learning-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>table_chart</mat-icon>
            Q-Table Insights
          </mat-card-title>
          <div class="header-actions">
            <button mat-icon-button (click)="toggleQValues()" 
                    [matTooltip]="showQValues ? 'Hide Q-Values' : 'Show Q-Values'">
              <mat-icon>{{ showQValues ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="q-learning-stats">
            <div class="stat-row">
              <span class="stat-label">Q-Table Size:</span>
              <span class="stat-value">{{ qTableSize }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Exploration Rate:</span>
              <span class="stat-value">{{ trainingStats?.explorationRate?.toFixed(3) || 'N/A' }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Best Action Confidence:</span>
              <span class="stat-value">{{ bestActionConfidence }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>